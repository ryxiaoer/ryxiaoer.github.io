<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>浅浅浅谈Mysql事务 | xiaoer's blogs</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.1.0"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script type="text/javascript" src="https://news.qq.com/newsweather/showWeather.js"></script><script src="//msite.baidu.com/sdk/c.js?appid=1603347506741536"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 5.2.0"></head><body><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.3},"mathjax":true});</script></body><div class="search-total"><div class="search-quanbu"></div><div class="showSerch"></div></div><div class="header-02" id="header-02"><div class="header-02-1"><div class="nav2" id="nav1"><div class="header-02-2"><span class="logo-line-before"><i></i></span><a href="/.">xiaoer's blogs</a><span class="logo-line-before"><i></i></span></div><div class="header-02-3"><a class="current" href="/."><i class="fa fa-home2"> 首页</i></a><a href="/archives/"><i class="fa fa-archive2"> 时间轴</i></a><a href="/music/"><i class="fa fa-user2"> 音乐</i></a><a href="/tool/"><i class="fa fa-user2"> 工具</i></a><a href="/comment/"><i class="fa fa-rss2"> 留言</i></a></div><div class="header-03"><div class="header-02-5" onclick="showBars()"> <a  href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></div><div class="header-02-4"> <a onclick="showSerch()" href="#"><i class="fa fa-search" aria-hidden="true"></i></a></div><div class="header-02-6"> <a  href="/."><i class="fa fa-home" aria-hidden="true"></i></a></div></div></div></div></div><div class="header-04" id="header-04" style="display: none;"> <div class="nav2"><a class="current" href="/."><i class="fa fa-home2"> homem</i></a><a href="/archives/"><i class="fa fa-archive2"> 时间轴</i></a><a href="/music/"><i class="fa fa-user2"> 音乐</i></a><a href="/tool/"><i class="fa fa-user2"> 工具</i></a><a href="/comment/"><i class="fa fa-rss2"> 留言</i></a><a href="/about/"><i class="fa fa-rss2"> 关于博主</i></a><a href="/site/"><i class="fa fa-rss2"> 关于本站</i></a><a href="/href/"><i class="fa fa-rss2"> 友情链接</i></a></div></div><div class="body_container"><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4" style="width: 100%;"><div class="content_container"><div class="post-02"></div><div class="post"><h1 class="post-title"><a href="/">浅浅浅谈Mysql事务</a></h1><div class="post-meta"><a href="https://ziyuan.baidu.com/xzh/commit/method?appid=1603347506741536" target="_Blank">10-08</a><span> | </span><span class="category"><a href="/categories/Code/">Code</a></span><span class="leancloud_visitors" id="/2020/10/08/blog-6.html" data-flag-title="文章阅读量统计">&nbsp;| <i class="fa fa-eye" aria-hidden="true"></i>&nbsp;<span class="leancloud-visitors-count"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">什么是事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">事务的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">一个事务的实现过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB"><span class="toc-number">3.</span> <span class="toc-text">事务的隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">3.1.</span> <span class="toc-text">事务的隔离级别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MVCC"><span class="toc-number">4.</span> <span class="toc-text">MVCC</span></a></li></ol></div></div><br><br><div class="post-content"><hr>
<h3 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h3><p>事务是数据库区别于文件系统的重要特征之一。它是由若干条SQL语句组成的。在事务中的操作，要么都做，要么都不做，是一个不可分割的单元。事务必须同时满足：<br><strong>原子性（Atomicity）</strong>：事务的所有操作，要么都做，要么都不做，不会结束在中间某个环节。<br><strong>隔离性（Isolation）</strong>：多个事务同时访问数据库中同一数据时，所表现出来的相互关系。<br><strong>持久性（Durability）</strong>：事务完成后，事务所做的修改进行持久化保存，不会丢失。<br><strong>一致性（Consistency）</strong> ：事务开始之前和事务结束之后，数据库的完整性没有被破坏。</p>
<h3 id="事务的实现"><a href="#事务的实现" class="headerlink" title="事务的实现"></a>事务的实现</h3><h4 id="一个事务的实现过程"><a href="#一个事务的实现过程" class="headerlink" title="一个事务的实现过程"></a>一个事务的实现过程</h4><p>假如执行如下一条语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;<span class="comment">--开启事务</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">test</span> <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">&#x27;exp1997&#x27;</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">rollback</span>;<span class="comment">--回滚</span></span><br><span class="line"><span class="keyword">commit</span>;<span class="comment">--提交</span></span><br></pre></td></tr></table></figure>
<p>在理解事务执行过程之前，首先要知道与其相关的几个文件（这里的每一个都足以写长篇）：</p>
<blockquote>
<p>1.<strong>重做日志</strong>。重做日志是用来实现事务的持久性的。主要是记录每个数据页数据变化的日志，在必要时对数据页进行重做。它由两部分组成：一是内存中的重做日志缓存（redo log buffer），二是重做日志文件（redo log file），默认在数据目录下有两个名为ib_logfile0 和ib_logfile1的重做日志文件。重做日志文件循环写入方式运行，InnoDB存储引擎先写ib_logfile0，当写到最后时，会切换到ib_logfile1，再当ib_logfile1写满时，会再切换回ib_logfile0中。<br>2.<strong>ibd文件</strong>。每创建一个表，都有一个“表名.ibd”的文件，这个文件主要存放该表的数据和索引。<br>3.<strong>缓存池（buffer pool）</strong>。就是一块内存区域，在数据库中读取页，首先将从磁盘读到的页放在缓存池中，对数据库页的修改操作，则首先修改缓存池中的页。<br>4.<strong>LSN</strong> ：就是日志序列号，这个序列号单调递增的，比如原本的序列号是1000，有一个事务写入了20个字节，那么 LSN就变成了1020。LSN不仅在重做日志中有，在每个数据页的头部，也记录了该页的LSN。数据页中的LSN表示最后刷新数据页时LSN的大小。<br>5.<strong>undo</strong>。 undo日志在ibdata1文件中存储，存储了事务工作过程中的<strong>回滚信息</strong>，在回滚时，实际上做的是与先前相 反的工作。对于insert，存储引擎会完成一个delete，对于每个delete，存储引擎会执行一个insert，对于update，存储引擎会完成一个相反的update，将修改前的数据放回去。</p>
</blockquote>
<p><strong>那么上述代码的实现过程究竟是什么样的？</strong></p>
<ol>
<li>首先，由io将test.ibd文件中的id=1所在的页（16K）调入buffer pool，然后对buffer pool中的信息进行修改，并将变化的信息记录到redo log buffer中。缺省情况，commit会立即将redo log buffer写入磁盘重做日志文件ib_logfiles中，日志落盘成功commit返回。buffer pool中的脏页由page cleaner thread每隔一段时间刷新回磁盘。 而当数据库宕机重启的时候，会将redo log中的内容加载到redo log buffer,由于redo log的LSN比磁盘的LSN新，两者数据不一致MySql是无法启动的。此时用redo log buffer的数据重做一下buffer pool中的数据，然后写回磁盘数据页，才能启动数据库恢复到数据库中，再根据undo  log和binlog内容决定回滚数据还是提交数据。上述过程实际解释了<strong>持久性和一致性</strong>的问题。</li>
<li>rollback。回滚是根据undo日志回滚，回到之前的某一个状态（savepoint的点）。<br>undo在生成过程中会记录redo信息，当发生异常时（如宕机），如果redo中的信息没有提交，此时，先用redo日志恢复，然后再根据undo信息回滚。redo和undo保证了<strong>原子性</strong>。<h3 id="事务的隔离"><a href="#事务的隔离" class="headerlink" title="事务的隔离"></a>事务的隔离</h3><blockquote>
<p>MySQL从概念上可以分为四层，顶层是接入层，不同语言的客户端通过mysql的协议与mysql服务器进行连接通信，接入层进行权限验证、连接池管理、线程管理等。下面是mysql服务层，包括sql解析器、sql优化器、数据缓冲、缓存等。再下面是mysql中的存储引擎层，mysql中存储引擎是基于表的。最后是系统文件层，保存数据、索引、日志等。<br>上述引用自：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f692d4f8a53e">https://www.jianshu.com/p/f692d4f8a53e</a></p>
</blockquote>
<h4 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h4>MySql中使用MVCC提高了事物的并发处理能力，但同时也带老生常谈的<strong>脏读、不可重复读和幻读</strong>的问题。<br>为了解决这些问题，数据库设置了四种隔离级别：<br><img src="/2020/10/08/blog-6.htm/%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png" alt="隔离级别"><br>InnoDB存储引擎默认隔离级别REPEATABLE READ，通过MVCC解决了幻读的问题。<h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3>MVCC是通过在每行记录后面保存两个隐藏的列来实现的。这两个列，一个保存了行的创建时间，一个保存行的过期时间（或删除时间）。当然存储的并不是实际的时间值，而是系统版本号（system version number)。每开始一个新的事务，系统版本号都会自动递增。事务开始时刻的系统版本号会作为事务的版本号，用来和查询到的每行记录的版本号进行比较。<br>mvcc是通过时间戳实现的。</li>
</ol>
</div><div style="padding-bottom: 10px;"><ul class="post-copyright">
<li class="post-copyright-author">
<strong>本文作者：</strong><a href="/about/">ryxiaoer</a><li class="post-copyright-link">
<strong>本文链接：</strong><a href="https://ryxiaoer.github.io/2020/10/08/blog-6.html">https://ryxiaoer.github.io/2020/10/08/blog-6.html</a><li class="post-copyright-license"><strong>版权声明：</strong><a href="/site/">本文所有权归博主所有，转载请注明出处！Thanks</a></div><script type="text/javascript" charset="utf-8" src="https://static.bshare.cn/b/buttonLite.js#uuid=2aceecbb-21d7-4746-a9db-3f8da046a833&amp;style=10&amp;bgcolor=Grey&amp;bp=sinaminiblog,qqim,qzone,weixin&amp;ssc=false"></script><div style="float:right;"><a class="bshareDiv"  href="www.bshare.cn/share">分享按钮</a></div><div class="tags"><a href="/tags/Mysql/">Mysql</a></div><div class="post-nav"><a class="pre" href="/2020/10/17/blog-7.html">muduo源码剖析 &amp; Linux多线程服务器端编程&lt;学习笔记 一&gt;</a><a class="next" href="/2020/10/08/blog-5.html">Rdis分布式锁笔记</a></div></div></div></div></div></div><div id="footer-000"><div id="footer-01" style="text-align:center;margin:auto;font-size:14px;background-color:#f5f5f5;"><div class="footer-div-a" style="max-width:1150px;display:flex;margin:0 auto"><div class="footer-div-b" style="padding-left:10px;padding-top:7px;padding-bottom:7px;text-align: left;"><a rel="nofollow">©2020  ❤ </a><a href="/." rel="nofollow" font-size="14px" font-weight="bold">xiaoer's blogs</a></div><div class="footer-div-b" style="padding-right:10px;padding-top:15px;padding-bottom:7px;text-align: right;"><a>&emsp;</a><a href="https://github.com/ryxiaoer/" target="_Blank" title="github" style="font-size:19px;"><i class="fa fa-github" aria-hidden="true"></i></a><a>&emsp;</a><a href="https://blog.csdn.net/weixin_44988779" target="_Blank" title="CSDN"><img class="nofancybox" width="15px" height="15px" src="/img/csdn.ico"/></a></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.1.0" async></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.1.0" async></script><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.1.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.1.0"></script></div></div></html><script type="text/javascript" src="/js/zidingyi.js" async></script>